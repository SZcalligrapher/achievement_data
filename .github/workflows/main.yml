# .github/workflows/update-manifest.yml
name: Update Manifest and Upload to OSS

on:
  push:
    paths:
      - "Posters/**"
      - "AchievementData.csv"

permissions:
  contents: write   # 允许 workflow push

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout 仓库
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          persist-credentials: false   # 不使用默认只读 token

      # 2. 设置 Python 环境
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      # 3. 安装 ossutil
      - name: Install ossutil
        run: |
          curl -o ossutil64 https://gosspublic.alicdn.com/ossutil/1.7.6/ossutil64
          chmod +x ossutil64
          sudo mv ossutil64 /usr/local/bin/ossutil

      # 4. 生成 manifest.json 并上传到 OSS（增量上传）
      - name: Generate manifest and upload to OSS
        env:
          OSS_BUCKET: ${{ secrets.OSS_BUCKET }}
          OSS_ENDPOINT: ${{ secrets.OSS_ENDPOINT }}
          OSS_ACCESS_KEY_ID: ${{ secrets.OSS_ACCESS_KEY_ID }}
          OSS_ACCESS_KEY_SECRET: ${{ secrets.OSS_ACCESS_KEY_SECRET }}
        run: |
          python Scripts/ManifestGenerator.py

      # 5. Commit & push manifest.json 如果有变化
      - name: Commit and push manifest if changed
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add manifest.json
          if git diff --cached --quiet; then
            echo "manifest.json 没有变化，跳过提交"
          else
            git commit -m "chore: update manifest.json"
            git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git main
          fi
